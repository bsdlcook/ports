#!/bin/sh

usage() {
	cat << EOF
usage: $(basename $0) [options]

Options:
  -p		-- Show only outdated ports
EOF
	exit 0
}

#
# Globals
#
REPOLOGY_BASE="https://repology.org"
REPOLOGY_API_VERSION=1
REPOLOGY_API="$REPOLOGY_BASE/api/v$REPOLOGY_API_VERSION"
REPOLOGY_PROJECT="$REPOLOGY_API/project"

#
# Command-line options
#
SHOW_OUTDATED_PORTS=

#
# Parse command-line options
#
while getopts :p flag; do
	case "$flag" in
		p) SHOW_OUTDATED_PORTS=1 ;;
		h | \?) usage ;;
	esac
done

#
# Echo out message if `-p` (list outdated ports) is not passed
#
echo_msg() {
	if [ ! "$SHOW_OUTDATED_PORTS" ]; then
		echo -e "$*"
	fi
}

#
# Grep for local port version
#
get_local_version() {
	grep -E "^(DIST|PORT)?VERSION=.*$" "$1/Makefile" | awk '{print $2}'
}

#
# Grab latest port version as reported on repology
#
get_remote_version() {
	local name="$1"

	case "$name" in
		ansible-sysrc) name=python:ansible-sysrc ;;
		gh) name=github-cli ;;
		py-*) name=$(echo "$name" | sed "s/py-/python:/") ;;
		tut) name=tut-mastodon-client ;;
	esac

	fetch -qo - "$REPOLOGY_PROJECT/$name" | jq -r '.[] | select(.repo == "freebsd") | .version'
}

PORT_LIST=
#
# Print port version status, as compared with latest on repology
#
display_port_versions() {
	local counter=0 uptodate=0 ahead=0 outdated=0

	echo_msg "===> Checking local git port version(s) with repology"
	for port in $(find . -type d -depth 2 -not -path "./.git/*" | cut -d/ -f 2,3 | sort); do
		port_name=$(echo "$port" | cut -d/ -f 2)
		port_local_version=$(get_local_version "$port")
		port_remote_version=$(get_remote_version "$port_name")
		port_check=$(pkg version -t "$port_local_version" "$port_remote_version")

		case "$port_check" in
			"=")
				echo_msg "=>> \e[32m$port is up-to-date\e[0m"
				uptodate=$((uptodate + 1))
				;;
			"<")
				echo_msg "=>> \e[33m$port $port_local_version is outdated by $port_remote_version\e[0m"
				oudated=$((outdated + 1))
				PORT_LIST="$PORT_LIST $port"
				;;
			">")
				echo_msg "=>> \e[36m$port $port_local_version is ahead of $port_remote_version\e[0m"
				ahead=$((ahead + 1))
				;;
		esac

		counter=$((counter + 1))
	done
	echo_msg "===> Finished checking $counter port version(s), OK: $uptodate, AHEAD: $ahead, OUTDATED: $outdated"
}

display_port_versions

if [ "$SHOW_OUTDATED_PORTS" ]; then
	echo "$PORT_LIST"
fi
